#!/bin/bash

MAPR_HOME=${MAPR_HOME:-/opt/mapr}
export MAPR_TICKETFILE_LOCATION=${MAPR_TICKETFILE_LOCATION:-"${MAPR_HOME}/conf/mapruserticket"}
SCHEMA_REGISTRY_VERSION=`cat "${MAPR_HOME}/schema-registry/schema-registryversion"`
SCHEMA_REGISTRY_HOME="${SCHEMA_REGISTRY_HOME:-${MAPR_HOME}/schema-registry/schema-registry-${SCHEMA_REGISTRY_VERSION}}"
SCHEMA_REGISTRY_CONF_FILE="${SCHEMA_REGISTRY_CONF_FILE:-${SCHEMA_REGISTRY_HOME}/etc/schema-registry/schema-registry.properties}"
NOW=`date "+%Y%m%d_%H%M%S"`
LOGFILE_BASE=${LOGFILE_BASE:-${SCHEMA_REGISTRY_HOME}/logs/verify_service.${NOW}.log}
PID_FILE=${MAPR_HOME}/pid/schemaregistry.pid

EXIT_SUCCESS=0
EXIT_NOT_RUNNING=1
EXIT_RUNNING_NOT_RESPONDING=2
EXIT_USAGE=3
EXIT_HTTP_ERROR=4
CONNECT_TIMEOUT=15
USAGE="$0 [-q]"
QUIET=0

if [ $# -eq 1 ] && [ "$1" == '-q' ]; then
    QUIET=1
elif [ $# -ge 1 ]; then
    echo $USAGE
    exit $EXIT_USAGE
fi

# Check if the process is running
echo "Starting verifier at $(date)" >> $LOGFILE_BASE
if [ -e "$PID_FILE" ] || [ -h "$PID_FILE" ]; then
    schema_registry_pid=$(cat $PID_FILE 2> /dev/null)
    if [ $? -ne 0 ]; then
        PID_FILE=$(ls -l $PID_FILE | awk '{print $11}')
        schema_registry_pid=$(cat $PID_FILE 2> /dev/null)
    fi
    if [ -z "$schema_registry_pid" ]; then
        echo "ERROR - could not get pid for schema-registry" >> $LOGFILE_BASE
        exit $EXIT_NOT_RUNNING
    fi
    echo "checking to see if pid $schema_registry_pid is alive" >> $LOGFILE_BASE
    if kill -s 0 $schema_registry_pid ; then
        echo "pid $schema_registry_pid is alive" >> $LOGFILE_BASE
        RC=$EXIT_RUNNING_NOT_RESPONDING
    else
        echo "pid $schema_registry_pid is NOT running" >> $LOGFILE_BASE
        [ $QUIET -eq 1 ] || cat $LOGFILE_BASE
        exit $EXIT_NOT_RUNNING
    fi
else
    echo "no pid file, schema-registry is NOT running" >> $LOGFILE_BASE
    [ $QUIET -eq 1 ] || cat $LOGFILE_BASE
    exit $EXIT_NOT_RUNNING
fi

# Check if the process is responding
echo "checking to see if schema-registry pid $schema_registry_pid is responsive" >> $LOGFILE_BASE
listeners=$(grep 'listeners=' "$SCHEMA_REGISTRY_CONF_FILE" | cut -d'=' -f 2 | sed -e 's/ //g')
protocol=$(echo $listeners | cut -d':' -f 1 | sed -e 's/ //g')
schema_registry_port=$(echo $listeners | cut -d':' -f 3 | sed -e 's/ //g')
schema_registry_ip=$(echo $listeners | cut -d':' -f 2 | sed -e 's/\///g')
if [ "$schema_registry_ip" = "0.0.0.0" ]; then
  schema_registry_ip="localhost"
fi
if [ "$protocol" == "https" ]; then
  # Getting MAPRSASL token
  token=$(java -cp `mapr classpath` com.mapr.security.client.examples.MapRClient gettoken -url "$protocol://${schema_registry_ip}:${schema_registry_port}" 2> /dev/null \
  |  grep 'Obtained challenge string' \
  |  sed -E 's/Obtained challenge string (.*)/\1/')
  OUTPUT=$(curl --noproxy '*' -s --write-out '%{http_code}' -k -H "Authorization: MAPR-Negotiate ${token}" "$protocol://${schema_registry_ip}:${schema_registry_port}")
else
  OUTPUT=$(curl --noproxy '*' -s --write-out '%{http_code}' "$protocol://${schema_registry_ip}:${schema_registry_port}")
fi

CRC=$?
if [ $CRC -ne 0 ]; then
    echo "schema-registry didn't respond - rc=$CRC, output = $OUTPUT" >> $LOGFILE_BASE
else
    echo "schema-registry responded - rc=$CRC, output = $OUTPUT" >> $LOGFILE_BASE
    http_code=${OUTPUT: -3}
    if [ $http_code -ne 200 ]; then
      RC=$EXIT_HTTP_ERROR
    else
      RC=$EXIT_SUCCESS
    fi
fi
[ $QUIET -eq 1 ] || cat $LOGFILE_BASE
exit $RC
